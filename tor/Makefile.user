STOWDEST ?= /usr/local/stow/tor

RM = trash

install: DESTDIR = /tmp/tor-0.2.7.6


centos-dep:
	#sudo yum install -y libevent-devel openssl-devel systemd-devel zlib-devel
	sudo yum install -y libevent-devel systemd-devel zlib-devel


tor-0.2.7.6.tar.gz:
	wget https://www.torproject.org/dist/$@
	wget https://www.torproject.org/dist/$@.asc
	tar atf $@
tor-0.2.7.6: tor-0.2.7.6.tar.gz
	tar axf $^ && $(RM) $^
config: tor-0.2.7.6
	sh $^/configure --with-tor-user=_tor --with-tor-group=_tor \
		--prefix=$(STOWDEST) --localstatedir=/var --sysconfdir=/usr/local/etc \
		--enable-systemd --enable-coverage --with-openssl-dir=/usr/local
install:
	id -u _tor || sudo useradd -d /usr/local/etc/tor -r -s /sbin/nologin -U _tor
	- mkdir -p $(STOWDEST)/etc
	sudo $(MAKE) install
	[ -f /usr/local/etc/tor/torrc ] && sudo cp -Ru -T /usr/local/etc/tor $(STOWDEST)/etc/tor
	@ echo Config left in /usr/local/etc/tor
post-install:
	sudo bash STOWDEST=$(STOWDEST) install.bash
	sudo bash STOWDEST=$(STOWDEST) centos-setup.bash
